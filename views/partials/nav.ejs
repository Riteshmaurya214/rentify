<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand" href="/">Rentify</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMenu">
      <form class="d-flex me-3" method="GET" action="/">
        <input class="form-control me-2" name="q" type="search" placeholder="Search title, description, location" value="<%= query && query.q ? query.q : '' %>">
        <button class="btn btn-outline-secondary" type="submit">Search</button>
      </form>

      <ul class="navbar-nav ms-auto d-flex flex-row gap-2 align-items-center">
        <li class="nav-item">
          <select id="filterCategory" class="form-select form-select-sm" onchange="applyFilters()" style="width:150px">
            <option value="all">All Categories</option>
            <% if(categories){ categories.forEach(c => { %>
              <option value="<%= c %>" <%= query && query.category===c ? 'selected' : '' %>><%= c %></option>
            <% }) } %>
          </select>
        </li>
        <li class="nav-item ms-2">
          <input id="filterLocation" class="form-control form-control-sm" style="width:160px" placeholder="Location" value="<%= query && query.location ? query.location : '' %>">
        </li>
        <li class="nav-item ms-2">
          <input id="minPrice" class="form-control form-control-sm" style="width:100px" placeholder="Min ₹" value="<%= query && query.minPrice ? query.minPrice : '' %>">
        </li>
        <li class="nav-item ms-2">
          <input id="maxPrice" class="form-control form-control-sm" style="width:100px" placeholder="Max ₹" value="<%= query && query.maxPrice ? query.maxPrice : '' %>">
        </li>

        <% if(!user){ %>
          <li class="nav-item"><a class="nav-link" href="/auth/login">Login</a></li>
          <li class="nav-item"><a class="nav-link" href="/auth/register">Register</a></li>
        <% } else { %>
          <li class="nav-item dropdown me-2">
            <a class="nav-link position-relative" href="#" id="notifBell" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-bell" style="font-size:1.2rem"></i>
              <% const unread = user.notifications ? user.notifications.filter(n => !n.read).length : 0; %>
              <% if(unread){ %>
                <span class="badge bg-danger rounded-pill position-absolute" style="top:-6px;right:-6px;font-size:0.7rem"><%= unread %></span>
              <% } %>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notifBell" style="width:320px;">
              <li class="dropdown-header">Notifications</li>
              <% if(user.notifications && user.notifications.length){ %>
                <% user.notifications.slice(0,8).forEach(n => { %>
                  <li class="dropdown-item">
                    <small class="text-muted d-block"><%= new Date(n.createdAt).toLocaleString() %></small>
                    <div><%= n.message %></div>
                    <% if(!n.read){ %> <span class="badge bg-primary">New</span> <% } %>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                <% }) %>
                <li class="dropdown-item text-center"><button id="markReadBtn" class="btn btn-sm btn-outline-primary">Mark all read</button></li>
              <% } else { %>
                <li class="dropdown-item text-center">No notifications</li>
              <% } %>
            </ul>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <%= user.name %>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
              <li><a class="dropdown-item" href="/dashboard">Dashboard</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/auth/logout">Logout</a></li>
            </ul>
          </li>
        <% } %>

        <li class="nav-item ms-3 d-flex align-items-center">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="themeToggle">
            <label class="form-check-label" for="themeToggle">Dark</label>
          </div>
        </li>

      </ul>
    </div>
  </div>
</nav>

<script>
  function applyFilters(){
    const params = new URLSearchParams(window.location.search);
    const cat = document.getElementById('filterCategory').value;
    const loc = document.getElementById('filterLocation').value;
    const min = document.getElementById('minPrice').value;
    const max = document.getElementById('maxPrice').value;
    if(cat) params.set('category', cat);
    if(loc) params.set('location', loc);
    if(min) params.set('minPrice', min);
    if(max) params.set('maxPrice', max);
    window.location.search = params.toString();
  }
</script>
